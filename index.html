let barChartInstance = null;
let pieChartInstance = null;

function calculateEnhancedROI() {
    try {
        // Safely access all inputs
        const cameraCost = parseFloat(document.getElementById('cameraCost')?.value || 0);
        const docCost = parseFloat(document.getElementById('docCost')?.value || 0);
        const surveyCost = parseFloat(document.getElementById('surveyCost')?.value || 0);
        const operatingExpenses = parseFloat(document.getElementById('operatingExpenses')?.value || 0);
        const travelTime = parseFloat(document.getElementById('travelTime')?.value || 0);
        const reviewTime = parseFloat(document.getElementById('reviewTime')?.value || 0);
        const projectsAnnually = parseInt(document.getElementById('projectsAnnually')?.value || 0);
        const billableRate = parseFloat(document.getElementById('billableRate')?.value || 0);

        // Calculations
        const docSavings = docCost * 0.8;
        const surveySavings = surveyCost * 0.7;
        const expenseSavings = operatingExpenses * 0.2;
        const travelSavings = travelTime * 0.5 * projectsAnnually * billableRate;
        const reviewSavings = reviewTime * 0.3 * projectsAnnually * billableRate;

        const totalSavings = docSavings + surveySavings + expenseSavings + travelSavings + reviewSavings;
        const paybackPeriod = cameraCost > 0 ? (cameraCost / totalSavings) : Infinity;
        const percentageROI = cameraCost > 0 ? ((totalSavings / cameraCost) * 100) : 0;

        // Update Results Safely
        document.getElementById('totalSavings').textContent = totalSavings.toFixed(2);
        document.getElementById('paybackPeriod').textContent = isFinite(paybackPeriod) ? paybackPeriod.toFixed(1) : 'N/A';
        document.getElementById('percentageROI').textContent = percentageROI.toFixed(2);

        // Update Table
        const savingsTableBody = document.getElementById('savingsTableBody');
        savingsTableBody.innerHTML = `
            <tr>
                <td>Documentation</td>
                <td>$${docCost.toFixed(2)}</td>
                <td>$${docSavings.toFixed(2)}</td>
                <td>${((docSavings / docCost) * 100).toFixed(2)}%</td>
            </tr>
            <tr>
                <td>Survey</td>
                <td>$${surveyCost.toFixed(2)}</td>
                <td>$${surveySavings.toFixed(2)}</td>
                <td>${((surveySavings / surveyCost) * 100).toFixed(2)}%</td>
            </tr>
            <tr>
                <td>Operating Expenses</td>
                <td>$${operatingExpenses.toFixed(2)}</td>
                <td>$${expenseSavings.toFixed(2)}</td>
                <td>${((expenseSavings / operatingExpenses) * 100).toFixed(2)}%</td>
            </tr>
            <tr>
                <td>Travel Time</td>
                <td>-</td>
                <td>$${travelSavings.toFixed(2)}</td>
                <td>-</td>
            </tr>
            <tr>
                <td>Review Time</td>
                <td>-</td>
                <td>$${reviewSavings.toFixed(2)}</td>
                <td>-</td>
            </tr>
        `;

        // Bar Chart: Original Costs vs. Savings
        if (barChartInstance) barChartInstance.destroy();
        const barCtx = document.getElementById('savingsBarChart').getContext('2d');
        barChartInstance = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ['Documentation', 'Survey', 'Operating Expenses', 'Travel Time', 'Review Time'],
                datasets: [
                    {
                        label: 'Original Costs',
                        data: [docCost, surveyCost, operatingExpenses, 0, 0],
                        backgroundColor: '#f44336', // Red for Original Costs
                    },
                    {
                        label: 'Savings',
                        data: [docSavings, surveySavings, expenseSavings, travelSavings, reviewSavings],
                        backgroundColor: '#4caf50', // Green for Savings
                    },
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: (context) => `$${context.raw.toFixed(2)}` } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Amount ($)',
                        },
                    },
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutCubic',
                }
            }
        });

        // Pie Chart: Proportions of Savings
        if (pieChartInstance) pieChartInstance.destroy();
        const pieCtx = document.getElementById('savingsPieChart').getContext('2d');
        pieChartInstance = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: ['Documentation', 'Survey', 'Operating Expenses', 'Travel Time', 'Review Time'],
                datasets: [{
                    data: [docSavings, surveySavings, expenseSavings, travelSavings, reviewSavings],
                    backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (context) => `$${context.raw.toFixed(2)}` } },
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutCubic',
                }
            }
        });
    } catch (error) {
        console.error('Error in ROI calculation:', error);
    }
}
